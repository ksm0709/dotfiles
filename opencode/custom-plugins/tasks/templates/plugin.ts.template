// src/index.ts
// OpenCode Tool handlers for tasks plugin

import { initCommand } from './commands/init';
import { listCommand } from './commands/list';
import { updateCommand } from './commands/update';
import { completeCommand } from './commands/complete';
import { removeCommand } from './commands/remove';
import { statusCommand } from './commands/status';
import { addTaskCommand } from './commands/add-task';

// Tool: tasks_init - Initialize a new task list
export async function tasks_init(params: {
  agent: string;
  title: string;
  file: string;
}): Promise<string> {
  try {
    await initCommand({
      agent: params.agent,
      title: params.title,
      file: params.file
    });
    return `✅ Task list "${params.title}" initialized successfully for agent "${params.agent}"`;
  } catch (error) {
    return `❌ Failed to initialize task list: ${error}`;
  }
}

// Tool: tasks_list - List all tasks
export async function tasks_list(params: {
  agent: string;
  format?: 'markdown' | 'json' | 'table';
}): Promise<string> {
  try {
    // Capture console output
    const originalLog = console.log;
    let output = '';
    console.log = (...args: any[]) => {
      output += args.join(' ') + '\n';
    };
    
    await listCommand({
      agent: params.agent,
      format: params.format || 'markdown'
    });
    
    console.log = originalLog;
    return output || `✅ Task list retrieved for agent "${params.agent}"`;
  } catch (error) {
    return `❌ Failed to list tasks: ${error}`;
  }
}

// Tool: tasks_update - Update task status
export async function tasks_update(params: {
  agent: string;
  id: string;
  status: 'pending' | 'in_progress' | 'completed';
}): Promise<string> {
  try {
    await updateCommand({
      agent: params.agent,
      id: params.id,
      status: params.status
    });
    return `✅ Task "${params.id}" updated to "${params.status}" for agent "${params.agent}"`;
  } catch (error) {
    return `❌ Failed to update task: ${error}`;
  }
}

// Tool: tasks_complete - Mark task as completed
export async function tasks_complete(params: {
  agent: string;
  id: string;
}): Promise<string> {
  try {
    await completeCommand({
      agent: params.agent,
      id: params.id
    });
    return `✅ Task "${params.id}" marked as completed for agent "${params.agent}"`;
  } catch (error) {
    return `❌ Failed to complete task: ${error}`;
  }
}

// Tool: tasks_add - Add a new task
export async function tasks_add(params: {
  agent: string;
  title: string;
  details?: string[];
  parent?: string;
}): Promise<string> {
  try {
    await addTaskCommand({
      agent: params.agent,
      title: params.title,
      details: params.details ? params.details.join(',') : undefined,
      parent: params.parent
    });
    return `✅ Task "${params.title}" added successfully for agent "${params.agent}"`;
  } catch (error) {
    return `❌ Failed to add task: ${error}`;
  }
}

// Tool: tasks_remove - Remove a task
export async function tasks_remove(params: {
  agent: string;
  id: string;
}): Promise<string> {
  try {
    await removeCommand({
      agent: params.agent,
      id: params.id,
      force: true // Auto-confirm when called as tool
    });
    return `✅ Task "${params.id}" removed successfully for agent "${params.agent}"`;
  } catch (error) {
    return `❌ Failed to remove task: ${error}`;
  }
}

// Tool: tasks_status - Get task status summary
export async function tasks_status(params: {
  agent: string;
}): Promise<string> {
  try {
    // Capture console output
    const originalLog = console.log;
    let output = '';
    console.log = (...args: any[]) => {
      output += args.join(' ') + '\n';
    };
    
    await statusCommand({
      agent: params.agent
    });
    
    console.log = originalLog;
    return output || `✅ Status retrieved for agent "${params.agent}"`;
  } catch (error) {
    return `❌ Failed to get status: ${error}`;
  }
}

// Export all tools as default object for OpenCode integration
export default {
  tasks_init,
  tasks_list,
  tasks_update,
  tasks_complete,
  tasks_add,
  tasks_remove,
  tasks_status
};
