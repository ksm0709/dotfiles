{
  "$schema": "https://opencode.ai/flows/v1/schema.json",
  "name": "tdd-cycle",
  "version": "1.0.0",
  "description": "Red-Green-Refactor TDD 사이클",
  
  "config": {
    "timeout": 600000,
    "max_retries": 3
  },
  
  "start": "write_test",
  
  "nodes": {
    "write_test": {
      "agent": "senior-sw-engineer",
      "prompt": "${prompt}\n\n위 요구사항에 대해 실패하는 테스트 코드를 먼저 작성하세요. (Red)\n\n[TDD 규칙]\n1. 테스트는 반드시 실패해야 합니다\n2. 최소한의 테스트만 작성하세요",
      
      "results": {
        "test_written": "테스트 코드 작성 완료",
        "needs_clarification": "요구사항 명확화 필요",
        "failed": "테스트 작성 실패"
      },
      
      "on": {
        "test_written": "run_test_red",
        "needs_clarification": "clarify",
        "failed": "error_handler"
      }
    },
    
    "run_test_red": {
      "run": "npm test -- --passWithNoTests 2>&1 || true",
      "expect_exit_code": 1,
      
      "on": {
        "success": "implement",
        "failed": "fix_test"
      }
    },
    
    "fix_test": {
      "agent": "senior-sw-engineer",
      "prompt": "테스트가 예상대로 실패하지 않았습니다:\n\n${history.run_test_red}\n\n테스트가 '실패'하도록 수정하세요.",
      
      "on": {
        "success": "run_test_red",
        "failed": "error_handler"
      }
    },
    
    "implement": {
      "agent": "senior-sw-engineer",
      "prompt": "테스트를 통과하도록 최소한의 코드를 구현하세요. (Green)\n\n실패한 테스트:\n${history.run_test_red}\n\n[규칙]\n1. 테스트 통과하는 최소한의 코드만 작성\n2. 과도한 일반화 금지",
      
      "on": {
        "success": "run_test_green",
        "failed": "implement"
      }
    },
    
    "run_test_green": {
      "run": "npm test",
      "expect_exit_code": 0,
      
      "on": {
        "success": "refactor",
        "failed": "implement"
      }
    },
    
    "refactor": {
      "agent": "senior-sw-engineer",
      "prompt": "코드를 리팩토링하세요. (Refactor)\n\n[리팩토링 포인트]\n1. 중복 제거\n2. 명확한 네이밍\n3. 단일 책임 원칙",
      
      "results": {
        "refactored": "리팩토링 완료",
        "no_changes": "추가 리팩토링 불필요"
      },
      
      "on": {
        "refactored": "final_test",
        "no_changes": "final_test"
      }
    },
    
    "final_test": {
      "run": "npm test",
      
      "on": {
        "success": "check_continue",
        "failed": "refactor"
      }
    },
    
    "check_continue": {
      "conditions": [
        {
          "field": "continue_tdd",
          "operator": "eq",
          "value": true,
          "result": "continue"
        }
      ],
      "default": "stop",
      
      "on": {
        "continue": "write_test",
        "stop": "success_end"
      }
    },
    
    "clarify": {
      "agent": "general",
      "prompt": "요구사항이 명확하지 않습니다. 다음 사항을 질문하세요:\n1. 구체적인 입력/출력 예시\n2. 엣지 케이스 처리 방법",
      
      "results": {
        "clarified": "요구사항이 명확해짐",
        "need_user": "사용자 입력 대기"
      },
      
      "on": {
        "clarified": "write_test",
        "need_user": "success_end"
      }
    },
    
    "error_handler": {
      "agent": "general",
      "prompt": "TDD 사이클 중 오류가 발생했습니다. 문제를 분석하고 해결하세요.",
      
      "on": {
        "success": "write_test",
        "failed": "failed_end"
      }
    },
    
    "success_end": {
      "end": true,
      "status": "success",
      "message": "✅ TDD 사이클이 성공적으로 완료되었습니다."
    },
    
    "failed_end": {
      "end": true,
      "status": "failed",
      "message": "❌ TDD 사이클이 실패했습니다."
    }
  }
}
