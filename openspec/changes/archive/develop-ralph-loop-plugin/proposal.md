# Proposal: Ralph Loop Plugin for OpenCode

## 배경 (Background)
오픈코드(OpenCode) 세션이 장시간 실행되거나 복잡한 작업을 수행할 때, AI 에이전트가 의도한 종료 지점(Promise Word)에 도달하지 못하고 유휴(Idle) 상태에 빠지는 경우가 있습니다. 이를 자동화된 루프 메커니즘을 통해 관리하여, 세션의 연속성을 보장하고 컨텍스트를 효율적으로 관리하고자 합니다.

## 목적 (Goals)
- 세션이 `idle` 상태가 되었을 때 자동으로 상태를 점검.
- 약속된 단어(Promise Word)가 출력되지 않았을 경우, 자동으로 컨텍스트를 요약 및 저장.
- 세션을 초기화하고 재시작하여 작업의 완결성을 높임.
- 최대 반복 횟수를 제한하여 무한 루프 방지 및 사용자 설정 제공.

## 요구사항 (Requirements)
- **R1: Idle 상태 감지**: 세션 상태가 `idle`로 변경되는 이벤트를 실시간으로 수신.
- **R2: 초기 프롬프트 인젝션**: 최초 세션 시작 시, 작업 완료 후 반드시 Promise Word를 출력하도록 지시하는 프롬프트를 자동으로 주입.
- **R3: Promise Word 검증**: 마지막 어시스턴트 메시지에 설정된 "Promise Word"가 포함되어 있는지 확인.
- **R4: 자동 프롬프트 주입**: 검증 실패 시, 세션 요약을 유도하는 프롬프트를 자동으로 전송.
- **R5: 컨텍스트 요약 및 저장**: 세션의 전체 내용을 요약하고 지정된 파일 경로에 저장.
- **R6: 세션 초기화 및 재시작**: 기존 세션의 컨텍스트를 비우거나 새 세션을 생성하여 작업을 재개.
- **R7: 반복 제어**: 최대 반복 횟수(기본 5회)를 관리하고 사용자 설정을 지원.

## 시나리오 (Scenarios)

#### Scenario: 최초 프롬프트 인젝션 성공
- **Given**: 사용자가 새로운 세션을 생성하고 첫 번째 메시지 "프로젝트 구조 분석해줘"를 전송함.
- **When**: 플러그인의 `chat.message` 훅이 실행됨.
- **Then**: 에이전트에게 전달되는 최종 메시지 끝에 "\n\n(중요: 모든 작업이 완료되면 반드시 'DONE'을 출력하세요.)"가 포함되어야 함.

#### Scenario: 작업 완료 및 루프 종료 (Promise Word 포함)
- **Given**: 에이전트가 작업을 마치고 마지막 메시지에 "분석을 마쳤습니다. DONE"을 포함함.
- **When**: 세션 상태가 `idle`로 변경됨.
- **Then**: 플러그인은 Promise Word를 감지하고, 추가 작업을 수행하지 않고 루프 상태를 초기화함.

#### Scenario: 작업 미완료 및 루프 실행 (Promise Word 미포함)
- **Given**: 에이전트가 작업을 수행하다가 Promise Word 없이 `idle` 상태가 됨.
- **When**: 세션 상태가 `idle`로 변경됨.
- **Then**: 
  1. 세션 요약(`summarize`)이 생성됨.
  2. `.opencode/sessions/(session-id)/ralph_summary.md`에 요약 내용이 저장됨.
  3. 기존 세션이 삭제되고 새 세션이 생성됨.
  4. 새 세션에 요약 내용과 함께 재시작 프롬프트가 전송됨.

#### Scenario: 최대 반복 횟수 도달 및 중단
- **Given**: `maxRetries`가 5로 설정되어 있고, 현재 `retryCount`가 5임.
- **When**: Promise Word 없이 다시 `idle` 상태가 됨.
- **Then**: 더 이상 루프를 실행하지 않고, 사용자에게 "최대 재시도 횟수에 도달했습니다"라는 알림(Toast)을 표시함.

#### Scenario: 요약 파일 저장 경로 검증
- **Given**: 세션 ID가 `sess_123`인 작업이 루프를 트리거함.
- **When**: 요약 저장 로직이 실행됨.
- **Then**: 파일이 반드시 `./.opencode/sessions/sess_123/ralph_summary.md` 경로에 생성되어야 함.

## 기대 효과 (Expected Impact)
- 장기 작업의 자동화 수준 향상.
- 세션 컨텍스트 비대화로 인한 성능 저하 및 비용 문제 해결.
- 작업 결과의 체계적인 기록(요약 파일) 보존.
