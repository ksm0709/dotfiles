# Proposal: Tasks 플러그인 버그 수정 및 세션 완료 체크 기능 추가

## 개요

Tasks 플러그인에 두 가지 중요한 업데이트를 제안합니다.

### 제안하는 변경사항

1. **버그 수정**: `update` 명령에서 `in_progress` 상태로 전환되지 않는 문제 해결
2. **기능 추가**: 세션 종료 시 미완료 task 자동 확인 및 사용자 프롬프트 직접 전송 기능

---

## 문제 배경 (Problem Statement)

### 버그: in_progress 상태 전환 실패

현재 Tasks 플러그인에서 `update` 명령을 사용하여 task 상태를 `in_progress`로 변경하려 할 때, 상태가 정상적으로 업데이트되지 않는 문제가 보고되었습니다. 이는 사용자가 작업을 "진행 중"으로 표시할 수 없게 하여, 작업 관리의 정확성을 해칩니다.

### 기능 부재: 세션 종료 시 미완료 task 확인

현재 세션이 종료될 때, 미완료된 task가 있는지 자동으로 확인하는 기능이 없습니다. 이로 인해 사용자가 작업을 완료하지 않고 세션을 종료하는 경우가 발생할 수 있으며, 이는 작업의 지속성과 완료율을 저하시킵니다.

---

## 해결 방안 (Proposed Solution)

### 버그 수정 방안

Parser 모듈의 task 파싱 로직을 검토하고, `in_progress` 상태가 마크다운 파일에서 올바르게 저장되고 파싱되는지 확인합니다. 필요한 경우 다음을 수정합니다:

1. `updateTaskStatus` 함수의 상태 값 검증
2. 마크다운 생성 시 `in_progress` 상태의 체크박스 표현
3. 마크다운 파싱 시 `in_progress` 상태 인식

### 세션 완료 체크 기능

세션 종료 이벤트를 감지하여 다음을 수행합니다:

1. 현재 세션의 모든 task 상태 확인
2. 미완료 task (pending 또는 in_progress)가 있는 경우:
   - 사용자에게 직접 프롬프트 전송: "task가 완료되지 않았으니 남은 task를 완료하라"
   - 미완료 task 목록 제공
3. 작업 완료를 유도하는 메시지 표시

---

## 기대 효과 (Expected Benefits)

1. **정확한 상태 관리**: `in_progress` 상태가 정상적으로 작동하여 작업 진행 상황을 정확히 추적
2. **작업 완료율 향상**: 세션 종료 시 미완료 task 알림으로 작업 누락 방지
3. **사용자 경험 개선**: 직관적인 작업 관리 및 완료 유도 메커니즘 제공

---

## 영향 범위 (Impact Assessment)

### 변경되는 컴포넌트

- `src/lib/parser.ts` - 버그 수정 (파싱/생성 로직)
- `src/index.ts` - 세션 종료 이벤트 핸들러 추가
- `src/lib/storage.ts` - 세션별 미완료 task 조회 기능 (필요시)

### 하위 호환성

- 기존 task 목록 파일과의 호환성 유지
- 기존 API 인터페이스 유지
- 새로운 기능은 옵트인 또는 자동 실행

---

## 리스크 및 고려사항 (Risks & Considerations)

1. **세션 종료 이벤트**: OpenCode 플러그인 시스템에서 세션 종료 이벤트를 받을 수 있는지 확인 필요
2. **사용자 경험**: 너무 빈번한 프롬프트가 방해가 될 수 있음 - 적절한 트리거 조건 설정 필요
3. **파일 형식 변경**: 마크다운 형식 변경 시 기존 파일과의 호환성 고려

---

## ADDED: 새로운 요구사항

### ADDED-001: in_progress 상태 전환 버그 수정

**설명**: `update` 명령으로 task 상태를 `in_progress`로 변경할 때, 상태가 정상적으로 업데이트되지 않는 버그를 수정합니다.

**수용 기준**:
- `update` 명령으로 `in_progress` 상태를 설정할 수 있어야 함
- 마크다운 파일에 `in_progress` 상태가 올바르게 저장되어야 함
- 파싱 시 `in_progress` 상태가 올바르게 인식되어야 함

#### Scenario: in_progress 상태 업데이트 성공

**Given**: 세션에 "1. 테스트 작업" task가 pending 상태로 존재
**When**: 사용자가 `update` 명령으로 id "1"의 상태를 `in_progress`로 변경 요청
**Then**: task 상태가 `in_progress`로 변경되고 마크다운 파일에 반영됨

#### Scenario: in_progress 상태 파싱 확인

**Given**: 마크다운 파일에 `in_progress` 상태의 task가 저장됨
**When**: Parser가 해당 파일을 파싱
**Then**: task의 status가 `in_progress`로 인식됨

---

### ADDED-002: 세션 종료 시 미완료 task 확인 및 프롬프트 주입 기능

**설명**: 세션이 종료될 때 현재 세션의 미완료 task를 자동으로 확인하고, 미완료 task가 있을 경우 **사용자가 직접 입력한 것처럼** 프롬프트를 세션으로 주입합니다. 이를 통해 에이전트의 다음 동작이 자동으로 트리거됩니다.

**수용 기준**:
- 세션 종료 이벤트 감지 가능해야 함 (`session.idle` 이벤트)
- 미완료 task (pending 또는 in_progress)를 식별할 수 있어야 함
- 미완료 task가 있을 경우 프롬프트를 **사용자 입력처럼 세션에 직접 전송**
- 프롬프트에는 미완료 task 목록과 완료 요청 메시지 포함
- 에이전트가 프롬프트를 "사용자 요청"으로 인식하고 다음 동작 수행

#### Scenario: 미완료 task가 있는 세션 종료

**Given**: 세션에 완료되지 않은 task (pending: 2개, in_progress: 1개)가 존재
**When**: 세션 종료 이벤트(`session.idle`) 발생
**Then**: 
1. 미완료 task 목록 확인
2. "⚠️ **작업 완료 알림** - 현재 세션에 완료되지 않은 작업이 있습니다..." 프롬프트를 **사용자가 입력한 것처럼 세션으로 주입**
3. 에이전트가 주입된 메시지를 받아 작업 완료를 유도하는 다음 동작 수행

#### Scenario: 모든 task가 완료된 세션 종료

**Given**: 세션의 모든 task가 completed 상태
**When**: 세션 종료 이벤트 발생
**Then**: 프롬프트 전송 없이 정상 종료

#### Scenario: 빈 세션 종료

**Given**: 세션에 task가 없음
**When**: 세션 종료 이벤트 발생
**Then**: 프롬프트 전송 없이 정상 종료

---

## 관련 문서

- `design.md` - 상세 설계 문서
- `tasks.md` - 구현 작업 목록
- `/opencode/custom-plugins/tasks/README.md` - Tasks 플러그인 문서
